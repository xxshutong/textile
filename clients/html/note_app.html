<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<!-- 
 Copyright (c) Open Source Strategies, Inc.

 Opentaps is free software: you can redistribute it and/or modify it
 under the terms of the GNU Affero General Public License as published
 by the Free Software Foundation, either version 3 of the License, or
 (at your option) any later version.

 Opentaps is distributed in the hope that it will be useful,
 but WITHOUT ANY WARRANTY; without even the implied warranty of
 MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 GNU Affero General Public License for more details.

 You should have received a copy of the GNU Affero General Public License
 along with Opentaps.  If not, see <http://www.gnu.org/licenses/>.
-->
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>opentaps 2 Notes Application</title>

<style type="text/css">

#content {
  margin-left: 20px;
  font-family: Verdana, Arial, Helvetica, sans-serif;
  font-size: 80%;
}

#content h1 {
  font-size: 100%;
  padding: 5px 0px 2px 4px;
}

.savebutton {
   background-color:#007e00;
   cursor:pointer;
   padding:10px;
   position:relative;
   font-family: Verdana, Arial, Helvetica, sans-serif;
   font-size:120%;
   text-decoration:none;
   color:#fff;
   border: solid 1px #831212;
   border-radius: 5px;
}

.savebutton:active {
   padding-bottom:9px;
   padding-left:10px;
   padding-right:10px;
   padding-top:11px;
   top:1px;
}

input[disabled] {
   background-color: #7a7a7a;
   color:#fff;
}

.logoutbutton {
   background-color:#007e00;
   cursor:pointer;
   font-family: Verdana, Arial, Helvetica, sans-serif;
   font-size:80%;
   text-decoration:none;
   color:#fff;
   width:52px;
}

.errorMessage,
.message,
.fieldErrorMessage
{
  font-family: Verdana, Arial, Helvetica, sans-serif;
  font-size: 100%;
  padding: 5px 0px 2px 4px;
}

.fieldErrorMessage,
.errorMessage { color:red; }

</style>

<script language="javascript" type="text/javascript">

function createRequest() {
  var xmlhttp;
  if (typeof XMLHttpRequest != 'undefined') { 
    return new XMLHttpRequest(); 
  }
  try {
    xmlhttp = new ActiveXObject("Msxml2.XMLHTTP");
  } catch (e) {
    try {
      xmlhttp = new ActiveXObject("Microsoft.XMLHTTP");
    } catch (e) {
      xmlhttp = false;
    }
  }
  return xmlhttp
}

function parseResponse(req) {
  var resp = req.responseText;
  switchButtonDisable(document.getElementById('createNoteButton'), false, "Create Note");

  if (resp) {
    var json = eval('(' + resp + ')');

    if (req.status == 201) { 
      showErrorMessage("");
      showSuccessMessage(json.result.successMessage);
      document.getElementById('noteText').value = "";
    } else {
      showSuccessMessage("");
      showErrorMessage(json.result.errorMessage.replace(/\n/g,'<br/>'), json.result.errorDetail);
      if (req.status == 401) {
        showLoginPrompt();
      }  
    }

  } else {
    showSuccessMessage("");
    showErrorMessage("Cannot get response from server."); 
  }

}

function showErrorMessage(message, details) {
    document.getElementById('errorMessage').innerHTML = message;
    // reset field errors
    var els = document.getElementById('createNote').getElementsByTagName("div");
    var elsLen = els.length;
    var pattern = new RegExp("(^|\\s)fieldErrorMessage(\\s|$)");
    for (i = 0, j = 0; i < elsLen; i++) {
        if (pattern.test(els[i].className)) {
            els[i].innerHTML = "";
        }
    }
    // check field errors in the details
    if (details) {
        var len = details.length;
        for (var i=0; i < len; i++) {
            var detail = details[i];
            var el = document.getElementById(detail.field + '_error');
            if (el) {
                el.innerHTML = detail.message;
            }
        }
    }
}

function showSuccessMessage(message) {
    document.getElementById('successMessage').innerHTML = message;
}

function saveNote(form){
  switchButtonDisable(document.getElementById('createNoteButton'), true, "Please Wait...");
  var req = createRequest(); 
  
  // Create the callback:
  req.onreadystatechange = function() {    
    if (req.readyState == 4) {        
        parseResponse(req);
    }
   
  }

  var params = 'noteText=' + encodeURIComponent(form["noteText"].value);
  params = params + '&userKey=' + encodeURIComponent(document.getElementById('userKey').value);

  req.open("POST", "http://localhost:8080/notes/note", true);
  req.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");

  req.send(params);
 
}

function switchButtonDisable(button, disabled, buttonText) {
  if (button) {
    button.disabled = disabled;
    button.value = buttonText;
  }
}

function getQueryVariable(variable) {
  var query = window.location.search.substring(1);
  var vars = query.split("&");
  for (var i=0;i<vars.length;i++) {
    var pair = vars[i].split("=");
    if (pair[0] == variable) {
      return pair[1];
    }
  } 
  return "";
}

function onLoadPage() {    
    var userKey = getQueryVariable("userKey");
    document.getElementById('userKey').value = userKey;   
    
    if (userKey == "") {
        showLoginPrompt();
    } else {
        getUser(userKey);
    }
}

function showLoginPrompt() {
    var userLogin = document.getElementById("userLogin");
    if (userLogin) {
        userLogin.style.display = "inline";
    }
}

function getUser(userKey) {
    var reqUser = createRequest();
    
    // Create the callback:
    reqUser.onreadystatechange = function() {    
        if (reqUser.readyState == 4) {        
            parseUserResponse(reqUser);
        }   
    }

    reqUser.open("GET", "http://localhost:8080/notes/user/"+userKey, true);

    reqUser.send(null);
}

/** 
  Facebook Sign In integration is configured in org.opentaps.notes.rest.FacebookResource in the notes.rest module
***/
function login() {
    window.location.href = "http://localhost:8080/notes/facebook/login";
}

function parseUserResponse(req) {
    var resp = req.responseText;
    showSuccessMessage("");
    showErrorMessage("");

    if (resp) {
        var json = eval('(' + resp + ')');

        if (req.status == 200) {
            showUserArea(json); 
        } else {
            showSuccessMessage("");
            showErrorMessage(json.result.errorMessage.replace(/\n/g,'<br/>'), json.result.errorDetail);
            showLoginPrompt();
        }

    } else {
        showErrorMessage("Cannot get response from server."); 
    }
}

function showUserArea(json) {
    var userArea = document.getElementById('userArea');
    if (userArea) {
        userArea.innerHTML = json.result.successMessage + " " + json.result.resultValue.user.name;
    }
    var userAreaPhoto = document.getElementById('userAreaPhoto');
    if (userAreaPhoto) {
        userAreaPhoto.src = "https://graph.facebook.com/" + json.result.resultValue.user.id + "/picture?type=square";
    }
    var userLogout = document.getElementById('userLogout');
    if (userLogout) {
        userLogout.style.display = "block";
    }
}

function hideUserArea(json) {
    var userArea = document.getElementById('userArea');
    if (userArea) {
        userArea.innerHTML = "";
    }
    var userAreaPhoto = document.getElementById('userAreaPhoto');
    if (userAreaPhoto) {
        userAreaPhoto.src = "";
    }
    var userLogout = document.getElementById('userLogout');
    if (userLogout) {
        userLogout.style.display = "none";
    }
}

function parseLogoutUserResponse(req) {
    var resp = req.responseText;
    showSuccessMessage("");
    showErrorMessage("");

    if (resp) {
        if (req.status == 200) {
            var userKey = getQueryVariable("userKey");
            document.getElementById('userKey').value = "";
            hideUserArea();
            showLoginPrompt();
        } 
    } else {
        showErrorMessage("Cannot get response from server."); 
    }
}

function logout() {
    var reqLogoutUser = createRequest();
    var userKey = document.getElementById('userKey');    

    // Create the callback:
    reqLogoutUser.onreadystatechange = function() {    
        if (reqLogoutUser.readyState == 4) {        
            parseLogoutUserResponse(reqLogoutUser);
        }   
    }

    reqLogoutUser.open("POST", "http://localhost:8080/notes/user/logout/"+userKey.value, true);
    reqLogoutUser.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");

    reqLogoutUser.send(null);
}

</script>

</head>

<body onLoad="javascript:onLoadPage()">

<div id="container">
  <div id="content"> 
    <table style="width:518px">
     <tr>
       <td style="width:70%">
         <img src="http://www.opentaps.org/images/opentaps_logo.png"/>
       </td>
        <td align="right" style="width:30%">
          <div id="userLogin" style="display:none">
          <a href="javascript:login()"><img src="images/fb_login.png"></a>
          </div>
         <img id="userAreaPhoto" src=""/>
         <div id="userLogout" style="display:none">
           <input type="button" name="logoutButton" id="logoutButton" value="Logout" onClick="logout()" class="logoutbutton"/>
         </div>
       </td>
     </tr>
     <tr>
       <td>
     	 <div id="userArea"/>         
       </td>
     </tr>
    </table>
    <input type="hidden" name="userKey" id="userKey"/>
    <form name="createNote" id="createNote" action="createNote" method="post">
    <table>
      <tr><td>
      <div class="fieldErrorMessage" id="noteText_error"></div>
      <textarea name="noteText" id="noteText" rows="6" cols="70" placeholder="Write your note here"></textarea> 
      </td></tr>
      <tr><td>
      <input type="button" name="createNoteButton" id="createNoteButton" value="Create Note" onClick="saveNote(this.form)" class="savebutton"/>
      </td></tr>
	  <tr><td>
        <div class="message" id="successMessage"></div>
        <div class="errorMessage" id="errorMessage"></div> 
	  </td></tr>	  
    </table>
    </form>
  </div>
</div>

</body>
</html>
