<!DOCTYPE html> 
<html> 
<head> 
    <title>NoteApp</title> 

    <meta name="viewport" content="width=device-width, initial-scale=1"> 

    <link rel="stylesheet" href="jquery.mobile-1.0.1.min.css" />
    <style type="text/css">
        .opentaps-logo {
            margin-top:6px;
            margin-bottom:6px;
            width:100%;
            background-color:#FFFFFF;
        }
        .field-error-message { 
            margin-bottom:6px; 
            color:red;
        }
        .error-message { color:red; }
    </style>
    <script type="text/javascript" charset="utf-8" src="phonegap-1.4.1.js"></script>
    <script type="text/javascript" charset="utf-8" src="childbrowser.js"></script>
    <script type="text/javascript" charset="utf-8" src="jquery-1.7.1.min.js"></script>
    <script type="text/javascript" charset="utf-8" src="jquery.mobile-1.0.1.min.js"></script>
    <script type="text/javascript">
    function createRequest() {
        xmlhttp = false;
        if (typeof XMLHttpRequest != 'undefined') { 
            return new XMLHttpRequest(); 
    	}
        return xmlhttp;
    }
    
    function parseResponse(req) {
        var resp = req.responseText;

    	if (resp) {
    	    var json = eval('(' + resp + ')');

    	    if (req.status == 201) { 
    	        showErrorMessage("");
    	        showSuccessMessage(json.result.successMessage);
    	        document.getElementById('noteText').value = "";
    	    } else {
    	        showSuccessMessage("");
    	        showErrorMessage(json.result.errorMessage.replace(/\n/g,'<br/>'), json.result.errorDetail);
    	        if (req.status == 401) {
    	        	   //showLoginPrompt();
    	        }  
    	   }
    	} else {
    	    showSuccessMessage("");
    	    showErrorMessage("Cannot get response from server."); 
    	}
    }

    function showErrorMessage(message, details) {
        document.getElementById('errorMessage').innerHTML = message;
        // reset field errors
        var els = document.getElementById('createNote').getElementsByTagName("div");
        var elsLen = els.length;
        var pattern = new RegExp("(^|\\s)field-error-message(\\s|$)");
        for (i = 0, j = 0; i < elsLen; i++) {
            if (pattern.test(els[i].className)) {
                els[i].innerHTML = "";
            }
        }
        // check field errors in the details
        if (details) {
            var len = details.length;
            for (var i=0; i < len; i++) {
                var detail = details[i];
                var el = document.getElementById(detail.field + '_error');
                if (el) {
                    el.innerHTML = detail.message;
                }
            }
        }
    }

    function showSuccessMessage(message) {
        document.getElementById('successMessage').innerHTML = message;
    }
    
    function saveNote(){        
    	var req = createRequest(); 
    	  
    	// Create the callback:
    	req.onreadystatechange = function() {    
    	    if (req.readyState == 4) {        
    	        parseResponse(req);
    	    }
    	   
    	}

    	var params = 'noteText=' + encodeURIComponent(this.form["noteText"].value);
    	params = params + '&userKey=' + encodeURIComponent(document.getElementById('userKey').value);
    	var postOnMyWall = document.getElementById('postOnMyWall').checked;
    	if (postOnMyWall) {
    	    params = params + '&postOnMyWall=Y';
    	} else {
    	    params = params + '&postOnMyWall=N';
    	}

    	req.open("POST", "http://192.168.0.68:8080/notes/note", true);
    	req.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
        req.send(params);    	 
    }
    
    function login() {
    	window.plugins.childBrowser.showWebPage("http://192.168.0.68:8080/notes/facebook/mlogin");
    }

    //register event listeners
    document.addEventListener("DOMContentLoaded", function () {
    	
        document.getElementById("createNoteButton").addEventListener("click", saveNote, false); 
        document.getElementById("loginButton").addEventListener("click", login, false);
        ChildBrowser.install();

    }, false)

    </script>
</head>

<body>
<div data-role="page" data-theme="d">
<div data-role="content" >
    <div data-role="header" data-position="inline" data-theme="d" > 
        <img src="images/opentaps_logo.png" width="180px"/>
        <a href="#" id="loginButton" class="ui-btn-right" data-theme="b">Login</a>
    </div>    
    <form name="createNote" id="createNote" action="createNote" method="post">    	  
        <input type="hidden" name="userKey" id="userKey"/>	
        <div class="field-error-message" id="noteText_error"></div>
        <textarea name="noteText" id="noteText" placeholder="Write your note here"></textarea>
        <input id="postOnMyWall" type="checkbox" name="postOnMyWall"  style="display:none"/>
        <button id="createNoteButton" type="button" data-theme="b">Create Note</button>           
        <div id="successMessage" class="message"></div>
        <div id="errorMessage" class="error-message" ></div>
    </form> 
</div>
</div>
</body>
</html>
