<!DOCTYPE html> 
<html> 
<head> 
    <title>NoteApp</title> 

    <meta name="viewport" content="width=device-width, initial-scale=1"> 

    <link rel="stylesheet" href="jquery.mobile-1.0.1.min.css" />
    <style type="text/css">
        .opentaps-logo {
            margin-top:6px;
            margin-bottom:6px;
            width:100%;
            background-color:#FFFFFF;
        }
        .field-error-message { 
            margin-bottom:6px; 
            color:red;
        }
        .error-message { color:red; }
        
        img.userPicture,
        .userPicture .noImage,
        .userPicture img { height:25px; width:25px; }
    </style>
    <script type="text/javascript" charset="utf-8" src="phonegap-1.4.1.js"></script>
    <script type="text/javascript" charset="utf-8" src="childbrowser.js"></script>
    <script type="text/javascript" charset="utf-8" src="jquery-1.7.1.min.js"></script>
    <script type="text/javascript" charset="utf-8" src="jquery.mobile-1.0.1.min.js"></script>
    <script type="text/javascript">
    var baseUrl = "http://notes.opentaps.com/notes/";
    //for local testing
    //var baseUrl = "http://192.168.0.68:8080/notes/"; 
    
    function createRequest() {
        xmlhttp = false;
        if (typeof XMLHttpRequest != 'undefined') { 
            return new XMLHttpRequest(); 
    	}
        return xmlhttp;
    }
    
    function parseResponse(req) {
        var resp = req.responseText;

    	if (resp) {
    	    var json = eval('(' + resp + ')');

    	    if (req.status == 201) { 
    	        showErrorMessage("");
    	        showSuccessMessage(json.result.successMessage);
    	        document.getElementById('noteText').value = "";
    	    } else {
    	        showSuccessMessage("");
    	        showErrorMessage(json.result.errorMessage.replace(/\n/g,'<br/>'), json.result.errorDetail);
    	        if (req.status == 401) {
    	        	   //showLoginPrompt();
    	        }  
    	   }
    	} else {
    	    showSuccessMessage("");
    	    showErrorMessage("Cannot get response from server."); 
    	}
    }

    function showErrorMessage(message, details) {
        document.getElementById('errorMessage').innerHTML = message;
        // reset field errors
        var els = document.getElementById('createNote').getElementsByTagName("div");
        var elsLen = els.length;
        var pattern = new RegExp("(^|\\s)field-error-message(\\s|$)");
        for (i = 0, j = 0; i < elsLen; i++) {
            if (pattern.test(els[i].className)) {
                els[i].innerHTML = "";
            }
        }
        // check field errors in the details
        if (details) {
            var len = details.length;
            for (var i=0; i < len; i++) {
                var detail = details[i];
                var el = document.getElementById(detail.field + '_error');
                if (el) {
                    el.innerHTML = detail.message;
                }
            }
        }
    }

    function showSuccessMessage(message) {
        document.getElementById('successMessage').innerHTML = message;
    }
    
    function saveNote(){        
    	var req = createRequest(); 
    	  
    	// Create the callback:
    	req.onreadystatechange = function() {    
    	    if (req.readyState == 4) {        
    	        parseResponse(req);
    	    }
    	   
    	}

    	var params = 'noteText=' + encodeURIComponent(this.form["noteText"].value);
    	params = params + '&userKey=' + encodeURIComponent(document.getElementById('userKey').value);
    	var postOnMyWall = document.getElementById('postOnMyWall').checked;
    	if (postOnMyWall) {
    	    params = params + '&postOnMyWall=Y';
    	} else {
    	    params = params + '&postOnMyWall=N';
    	}

    	req.open("POST", baseUrl + "note", true);
    	req.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
        req.send(params);    	 
    }
    
    function login() {    	
    	window.plugins.childBrowser.showWebPage(baseUrl + "facebook/mlogin");
        window.plugins.childBrowser.onLocationChange = function(loc){ locationChange(loc); };
    }
    
    function parseLogoutUserResponse(req) {
        var resp = req.responseText;
        showSuccessMessage("");
        showErrorMessage("");

        if (resp) {
            if (req.status == 200) {
                var userKey = getQueryVariable("userKey");
                document.getElementById('userKey').value = "";
                hideUserArea();
            }
        } else {
            showErrorMessage("Cannot get response from server.");
        }
    }

    function logout() {
        var reqLogoutUser = createRequest();
        var userKey = document.getElementById('userKey');

        // Create the callback:
        reqLogoutUser.onreadystatechange = function() {
            if (reqLogoutUser.readyState == 4) {
                parseLogoutUserResponse(reqLogoutUser);
            }
        }

        reqLogoutUser.open("POST", baseUrl + "user/logout/" + userKey.value, true);
        reqLogoutUser.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");

        reqLogoutUser.send(null);
    }
    
    function locationChange(loc) {    	
    	if (loc.indexOf("notes/facebook/success?userKey") >= 0) {
    		var userKey = "";
    		index = loc.indexOf("?");
    		if (index >= 0) {
    		    userKey = getQueryVariable(loc.substring(index + 1), "userKey");
    		}
    	    document.getElementById("userKey").value = userKey;

    	    if (userKey == "") {
    	        showLoginPrompt();
    	    } else {
    	        getAppUser(userKey);
    	    }
    	    
    	    window.plugins.childBrowser.close();
    	}
    }
    
    function getQueryVariable(query, variable) {
        var vars = query.split("&");
        for (var i=0; i < vars.length; i++) {
            var pair = vars[i].split("=");
            if (pair[0] == variable) {
                return pair[1];
            }
        }
        return "";
                
    }
    
    function showLoginPrompt() {
        var loginButton = document.getElementById("loginButton");
        if (loginButton) {
        	loginButton.style.display = "inline";
        }
        
        var logoutButton = document.getElementById("logoutButton");
        if (logoutButton) {
            logoutButton.style.display = "none";
        }
    }
    
    function showLogoutPrompt() {    	
        var logoutButton = document.getElementById("logoutButton");
        if (logoutButton) {
        	logoutButton.style.display = "inline";
        }
        
        var loginButton = document.getElementById("loginButton");
        if (loginButton) {
            loginButton.style.display = "none";
        }
    }

    function getAppUser(userKey) {
        var reqUser = createRequest();

        // Create the callback:
        reqUser.onreadystatechange = function() {
            if (reqUser.readyState == 4) {
                parseUserResponse(reqUser);
            }
        }

        reqUser.open("GET", baseUrl + "user/" + userKey, true);

        reqUser.send(null);
    }
    
    function showUserArea(json) {
    	showLogoutPrompt();
    	
    	var userArea = document.getElementById('userArea');
        if (userArea) {
            userArea.innerHTML = json.result.successMessage + " " + json.result.resultValue.user.name;
        }
        
        var userAreaPhoto = document.getElementById('userAreaPhoto');
        if (userAreaPhoto) {
            userAreaPhoto.src = getFacebookUserPictureUrl(json.result.resultValue.user.id);
            userAreaPhoto.style.display = "inline";
        }
        
        var postOnMyWall = document.getElementById('postOnMyWall');
        if (postOnMyWall) {
            postOnMyWall.style.display = "block";
        }

        var postOnMyWallLabel = document.getElementById('postOnMyWallLabel');
        if (postOnMyWallLabel) {
            postOnMyWallLabel.style.display = "block";
        }
    }
    
    function hideUserArea(json) {
    	showLoginPrompt();
    	
        var userArea = document.getElementById('userArea');
        if (userArea) {
            userArea.innerHTML = "";
        }
        
        var userAreaPhoto = document.getElementById('userAreaPhoto');
        if (userAreaPhoto) {
            userAreaPhoto.src = "";
            userAreaPhoto.style.display = "none";
        }
        
        var postOnMyWall = document.getElementById('postOnMyWall');
        if (postOnMyWall) {
            postOnMyWall.style.display = "none";
        }
        
        var postOnMyWallLabel = document.getElementById('postOnMyWallLabel');
        if (postOnMyWallLabel) {
            postOnMyWallLabel.style.display = "none";
        }
    }
    
    function getFacebookUserPictureUrl(userId) {
        return "https://graph.facebook.com/" + userId + "/picture?type=square";
    }

    function parseUserResponse(req) {
        var resp = req.responseText;
        showSuccessMessage("");
        showErrorMessage("");

        if (resp) {
            var json = eval('(' + resp + ')');

            if (req.status == 200) {
                showUserArea(json);
            } else {
                showSuccessMessage("");
                showErrorMessage(json.result.errorMessage.replace(/\n/g,'<br/>'), json.result.errorDetail);
                showLoginPrompt();
            }

        } else {
            showErrorMessage("Cannot get response from server.");
        }
    }

    //register event listeners
    document.addEventListener("DOMContentLoaded", function () {    	
        document.getElementById("createNoteButton").addEventListener("click", saveNote, false); 
        document.getElementById("loginButton").addEventListener("click", login, false);
        document.getElementById("logoutButton").addEventListener("click", logout, false);
        ChildBrowser.install();
    }, false)

    </script>
</head>

<body>
<div data-role="page" data-theme="d">
<div data-role="content" >
    <div data-role="header" data-position="inline" data-theme="d" > 
        <img src="images/opentaps_logo.png" width="180px"/>
        <a href="#" id="loginButton" class="ui-btn-right" data-theme="b">Login</a>
        <a href="#" id="logoutButton" class="ui-btn-right" data-theme="a" style="display:none">Logout</a>
    </div>    
    <form name="createNote" id="createNote" action="createNote" method="post"> 
        <label id="userArea"></label>
        <img style="display:none" id="userAreaPhoto" src="" class="userPicture"/>   	  
        <input type="hidden" name="userKey" id="userKey"/>	
        <div class="field-error-message" id="noteText_error"></div>
        <textarea name="noteText" id="noteText" placeholder="Write your note here"></textarea>
        <input id="postOnMyWall" type="checkbox" name="postOnMyWall" class="custom" style="display:none" checked="checked" data-theme="c"/>       
        <label id="postOnMyWallLabel" for="postOnMyWall" style="display:none" data-theme="c">Also post on my wall</label>
        <button id="createNoteButton" type="button" data-theme="b">Create Note</button>           
        <div id="successMessage" class="message"></div>
        <div id="errorMessage" class="error-message" ></div>
    </form> 
</div>
</div>
</body>
</html>
